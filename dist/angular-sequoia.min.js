!function(){"use strict";angular.module("ngSequoia",["angular-lodash","as.sortable"])}(),function(){"use strict";function e(){return{restrict:"AE",replace:!0,templateUrl:"sequoia-search.html",scope:{tree:"=",isSearching:"=",buttons:"="},link:function(e){e.search=function(){e.query.length?(e.isSearching=e.query?!0:!1,e.tree.setNodesInPath(e.tree.nodes),e.tree.setCurrentNodes(e.tree.find(e.tree.template.title,e.query))):e.clear()},e.clear=function(){e.query="",e.isSearching=!1,e.tree.setCurrentNodes(e.tree.getNodesInPath())}}}}angular.module("ngSequoia").directive("sequoiaSearch",e)}(),function(){"use strict";var e={edit:"Edit",select:"Select",deselect:"Deselect",goToSubitems:"Go to subitems",addSubitems:"Add subitems",addNode:"Add node",remove:"Delete",done:"Done",searchClear:"&times;",showSelected:"Show selected",hideSelected:"Hide selected",backToList:"Back to list",move:"Move",modalSelect:"Select"},t={id:"_id",nodes:"nodes",title:"title"},n={allowSelect:!0,canEdit:!1,inline:!1,buttons:{},limit:0};angular.module("ngSequoia").constant("BUTTONS",e).constant("NODE_TEMPLATE",t).constant("DEFAULT_OPTIONS",n)}(),function(){"use strict";function e(e,t,n){return{restrict:"AE",replace:!0,templateUrl:"angular-sequoia.html",scope:{treeNodes:"=sequoiaTree",model:"=ngModel",template:"=nodeTemplate",options:"="},link:function(a){function i(){a.options=_.defaults(a.options||{},n),a.canEdit=a.options.canEdit,a.inline=a.options.inline,a.allowSelect=a.options.allowSelect,a.isMultiSelect=1===a.options.limit?!1:!0,a.model=a.isMultiSelect?_.isArray(a.model)?a.model:[]:"",a.breadcrumbs=[],a.tree=new e(angular.copy(a.treeNodes),a.template),a.buttons={edit:a.options.buttons.edit?a.options.buttons.edit:t.edit,select:a.options.buttons.select?a.options.buttons.select:t.select,deselect:a.options.buttons.deselect?a.options.buttons.deselect:t.deselect,goToSubitems:a.options.buttons.goToSubitems?a.options.buttons.goToSubitems:t.goToSubitems,addSubitems:a.options.buttons.addSubitems?a.options.buttons.addSubitems:t.addSubitems,addNode:a.options.buttons.addNode?a.options.buttons.addNode:t.addNode,remove:a.options.buttons.remove?a.options.buttons.remove:t.remove,done:a.options.buttons.done?a.options.buttons.done:t.done,searchClear:a.options.buttons.searchClear?a.options.buttons.searchClear:t.searchClear,showSelected:a.options.buttons.showSelected?a.options.buttons.showSelected:t.showSelected,hideSelected:a.options.buttons.hideSelected?a.options.buttons.hideSelected:t.hideSelected,backToList:a.options.buttons.backToList?a.options.buttons.backToList:t.backToList,move:a.options.buttons.move?a.options.buttons.move:t.move,modalSelect:a.options.buttons.modalSelect?a.options.buttons.modalSelect:t.modalSelect}}a.load=function(e){a.onlySelected=!1,a.tree.isValidNode(e)?(a.tree.setCurrentNodes(e[a.tree.template.nodes]),a.breadcrumbs=a.tree.breadcrumbs(e[a.tree.template.id])):(a.tree.setCurrentNodes(),a.breadcrumbs=[])},a.select=function(e){e[a.tree.template.id]&&(0!==a.options.limit&&a.model.length===a.options.limit?a.notification="You cannot select more than "+a.options.limit+" items!":a.isMultiSelect?a.model.push(e[a.tree.template.id]):a.model=e[a.tree.template.id])},a.deselect=function(e){if(a.isMultiSelect){var t=e[a.tree.template.id]?_.indexOf(a.model,e[a.tree.template.id]):-1;-1!==t&&a.model.splice(t,1)}else a.model=""},a.isSelected=function(e){return a.isMultiSelect?-1!==_.indexOf(a.model,e[a.tree.template.id])?!0:!1:a.model===e[a.tree.template.id]},a.toggleSelected=function(){if(a.onlySelected)a.onlySelected=!1,a.tree.setCurrentNodes(a.tree.getNodesInPath());else{a.onlySelected=!0;var e=a.tree.findSelected(a.model);a.tree.setNodesInPath(a.tree.nodes),a.tree.setCurrentNodes(e)}},i(),a.$watch("treeNodes",function(t){t&&(a.tree=new e(angular.copy(a.treeNodes),a.template),a.load())},!0),a.inline||a.load(),a.showModal=function(){a.load(),a.modalShown=!0},a.closeModal=function(){a.modalShown=!1},a.toggleEditing=function(e){a.isEditing&&(e.isSubmitted=!0),(!e||e.$valid)&&(a.treeNodes=angular.copy(a.tree.tree),a.isEditing=!a.isEditing)},a.addNode=function(e){a.tree.isValidNode(e)&&a.load(e),a.tree.nodes.push(a.tree.newNode()),a.isEditing=!0},a.remove=function(e){var t=e?_.indexOf(a.tree.nodes,e):-1;-1!==t&&a.tree.nodes.splice(t,1)},a.closeNotification=function(){a.notification=""}}}}e.$inject=["SequoiaTree","BUTTONS"],angular.module("ngSequoia").directive("sequoiaTree",e)}(),function(){"use strict";function e(e,t){var n,a,i,o,s,d,l,r,u=function(e,a){this.template=a||t,this.tree=n(_.isArray(e)?e[0]:{},this.template)?e:[]};return r=function(){var e=function(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)};return e()},n=function(t,n){if(!t)return!1;for(var a=_.values(n),i=0;i<a.length;i++)if(!_.has(t,a[i]))return e.warn("The node structure is not valid!"),!1;return!0},a=function(e,t,n,i){return _.isArray(e)?_.some(e,function(e){return e[t]===n?!0:a(e[i.nodes],t,n,i)}):!1},i=function(e,t,n,a,o){if(_.isArray(e))for(var s=0;s<e.length;s++)e[s][t].toLowerCase().indexOf(n.toLowerCase())>-1&&a.push(e[s]),i(e[s][o.nodes],t,n,a,o);return a},o=function(e,t,n,i){t=t||[];var s={};s[i.title]="Root",n=n.length?n:[s];for(var d=0;d<t.length;d++)(t[d][i.id]===e||a(t[d][i.nodes],i.id,e,i))&&n.push(t[d]),o(e,t[d][i.nodes],n,i);return n},s=function(e,t,n,i){t=t||[];for(var o=0;o<t.length;o++)(t[o][i.id]===e[i.id]||a(t[o][i.nodes],i.id,e[i.id],i))&&(n+=n.length?" > ":"",n+=_.trunc(t[o][i.title],20)),n=s(e,t[o][i.nodes],n,i);return n},d=function(e,t,n,a){if(_.isArray(t))for(var i=0;i<t.length;i++)t[i]._id===e&&n.push(t[i]),d(e,t[i][a.nodes],n,a);return n},l=function(e,t,n){var a={};return a[n.id]=e[n.id],a[n.title]=s(e,t,"",n),_.isArray(e[n.nodes])&&e[n.nodes].length>0&&(a[n.nodes]=e[n.nodes]),a},u.prototype.setCurrentNodes=function(e){this.nodes=_.isArray(e)?e:this.tree},u.prototype.setNodesInPath=function(e){this.nodesInPath=_.isArray(e)?e:this.tree},u.prototype.getNodesInPath=function(){return _.isArray(this.nodesInPath)?this.nodesInPath:this.tree},u.prototype.isValidNode=function(e){return _.isObject(e)&&e[this.template.nodes]},u.prototype.breadcrumbs=function(e){return o(e,this.tree,[],this.template)},u.prototype.find=function(e,t){for(var n=[],a=i(this.tree,e,t,[],this.template),o=0;o<a.length;o++)n.push(l(a[o],this.tree,this.template));return n},u.prototype.findSelected=function(t){var n=[],a=[];if(_.isArray(t)){for(var i=0;i<t.length;i++)n=_.union(n,d(t[i],this.tree,[],this.template));for(var o=0;o<n.length;o++)a.push(l(n[o],this.tree,this.template))}else _.isString(t)?(n=d(t,this.tree,[],this.template),a.push(l(n[0],this.tree,this.template))):e.warn("You must pass an array of IDs or a single ID in order to find the selected nodes!");return a},u.prototype.newNode=function(){var e={};return e[this.template.id]=r(),e[this.template.title]="",e[this.template.nodes]=[],e},u}e.$inject=["$log","NODE_TEMPLATE"],angular.module("ngSequoia").factory("SequoiaTree",e)}(),angular.module("ngSequoia").run(["$templateCache",function(e){e.put("angular-sequoia.html",'<div class="sequoia">\n  <div class="sequoia-modal-container" data-ng-if="!inline">\n    <a href="" class="sequoia-button sequoia-button-info" data-ng-click="showModal()" data-ng-bind="model.length ? isMultiSelect ? buttons.modalSelect + \' (\' + model.length + \')\' : buttons.modalSelect + \' (1)\' : buttons.modalSelect"></a>\n    <div class="sequoia-overlay" data-ng-show="modalShown"></div>\n    <div class="sequoia-modal" data-ng-show="modalShown">\n      <div class="sequoia-modal-title">\n        <h4 class="pull-left" data-ng-bind-html="buttons.modalSelect"></h4>\n        <a href="" class="sequoia-modal-close pull-right" data-ng-click="closeModal()">&times;</a>\n      </div>\n      <div data-ng-include="\'sequoia-tree.html\'"></div>\n    </div>\n  </div>\n\n  <div data-ng-if="inline" data-ng-include="\'sequoia-tree.html\'"></div>\n\n</div>\n'),e.put("sequoia-breadcrumbs.html",'<li data-ng-if="breadcrumbs.length" data-ng-repeat="link in breadcrumbs" data-ng-class="$last ? \'last\' : \'\'" data-ng-init="title = link[tree.template.title].length > 23 ? (link[tree.template.title] | limitTo:20) + \'&hellip;\' : link[tree.template.title]">\n  <a data-ng-if="!$last" href="" data-ng-click="load(link)" data-ng-bind="title"></a>\n  <span data-ng-if="$last" data-ng-bind="title"></span>\n</li>'),e.put("sequoia-item-actions.html",'<span data-ng-if="allowSelect && isSelected(node)">\n  <a class="sequoia-button sequoia-button-danger" href="" title="Deselect" data-ng-click="deselect(node)" data-ng-bind-html="buttons.deselect"></a>\n</span>\n\n<span data-ng-if="allowSelect && !isSelected(node)">\n  <a class="sequoia-button sequoia-button-primary" href="" title="Select" data-ng-click="select(node)" data-ng-bind-html="buttons.select"></a>\n</span>\n\n<span data-ng-if="node[tree.template.nodes] && node[tree.template.nodes].length">\n  <a class="sequoia-button sequoia-button-info" href="" title="Go to subitems" data-ng-click="load(node)" data-ng-bind-html="buttons.goToSubitems"></a>\n</span>\n'),e.put("sequoia-item-edit-actions.html",'<span>\n  <a class="sequoia-button sequoia-button-danger" href="" title="Remove" data-ng-click="remove(node)" data-ng-bind-html="buttons.remove"></a>\n</span>\n\n<span data-ng-if="node[tree.template.nodes] && node[tree.template.nodes].length">\n  <a class="sequoia-button sequoia-button-info" href="" title="Go to subitems" data-ng-click="load(node)" data-ng-bind-html="buttons.goToSubitems"></a>\n</span>\n\n<span data-ng-if="!node[tree.template.nodes] || !node[tree.template.nodes].length">\n  <a class="sequoia-button sequoia-button-info" href="" title="Add subitems" data-ng-click="addNode(node)" data-ng-bind-html="buttons.addSubitems"></a>\n</span>\n\n<span data-as-sortable-item-handle>\n  <a class="sequoia-button sequoia-button-default" href="" data-ng-bind-html="buttons.move"></a>\n</span>'),e.put("sequoia-item.html",'<span class="sequoia-item-title">\n  <span data-ng-if="!isEditing" data-ng-bind="node[tree.template.title]"></span>\n  <span data-ng-if="isEditing">\n    <input required name="itemTitle_{{node[tree.template.id]}}" type="text" data-ng-model="node[tree.template.title]" placeholder="Enter a {{tree.template.title}}">\n    <p class="help-text has-error" data-ng-show="form.isSubmitted && form[\'itemTitle_\' + node[tree.template.id]].$error.required">The item {{tree.template.title}} is required!</p>\n  </span>\n</span>\n\n<span class="sequoia-item-actions" data-ng-include="\'sequoia-item-actions.html\'" data-ng-if="!isEditing"></span>\n<span class="sequoia-item-actions" data-ng-include="\'sequoia-item-edit-actions.html\'" data-ng-if="isEditing"></span>\n'),e.put("sequoia-search.html",'<ng-form name="sequoiaSearchForm" data-ng-submit="search()" novalidate>\n  <input type="text" placeholder="Search for an item by {{tree.template.title}}" data-ng-model="query" name="search" />\n  <a class="sequoia-button sequoia-button-default" href="" data-ng-if="isSearching" data-ng-click="clear()" data-ng-bind-html="buttons.searchClear"></a>\n</ng-form>\n'),e.put("sequoia-tree-actions.html",'<ul>\n  <li data-ng-if="(model.length || onlySelected) && !isEditing">\n    <a class="sequoia-button sequoia-button-info" href="" data-ng-click="toggleSelected()" data-ng-bind-html="model.length && !onlySelected ? buttons.showSelected : !model.length && onlySelected ? buttons.backToList : buttons.hideSelected"></a>\n  </li>\n\n  <li data-ng-if="isEditing || !tree.tree.length">\n    <a class="sequoia-button sequoia-button-success" href="" data-ng-click="addNode()" data-ng-bind-html="buttons.addNode"></a>\n  </li>\n\n  <li data-ng-if="canEdit && tree.tree.length">\n    <a class="sequoia-button sequoia-button-info" href="" data-ng-click="toggleEditing(sequoiaEditForm)" data-ng-bind-html="isEditing ? buttons.done : buttons.edit"></a>\n  </li>\n\n</ul>\n'),e.put("sequoia-tree.html",'<ng-form name="sequoiaEditForm" novalidate>\n\n  <div class="sequoia-search">\n    <div class="sequoia-search-form" data-sequoia-search data-is-searching="searchEnabled" data-tree="tree" data-buttons="buttons"></div>\n\n    <div class="sequoia-actions" data-ng-include="\'sequoia-tree-actions.html\'"></div>\n  </div>\n\n  <ul data-ng-if="!searchEnabled && !onlySelected" class="sequoia-breadcrumbs" data-ng-include="\'sequoia-breadcrumbs.html\'"></ul>\n\n  <div class="sequoia-notification" data-ng-show="notification">\n    <p>\n      <span class="pull-left" data-ng-bind="notification"></span>\n      <a class="pull-right sequoia-button" href="" data-ng-click="closeNotification()" data-ng-bind-html="buttons.searchClear"></a>\n    </p>\n  </div>\n\n  <ul data-ng-if="isEditing" id="sequoia-tree" class="sequoia-tree" data-as-sortable="{ containment: \'#sequoia-tree\', containerPositioning: \'relative\' }" data-ng-model="tree.nodes">\n    <li data-ng-repeat="node in tree.nodes track by node[tree.template.id]" data-as-sortable-item data-ng-include="\'sequoia-item.html\'"></li>\n  </ul>\n\n  <ul data-ng-if="!isEditing" id="sequoia-tree" class="sequoia-tree">\n    <li data-ng-repeat="node in tree.nodes track by node[tree.template.id]" data-ng-include="\'sequoia-item.html\'"></li>\n  </ul>\n\n</ng-form>\n')}]);